<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P3 Life Cycles of Plants and Animals - Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; padding: 2rem; }
    .question { background: #fff; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .feedback { margin-top: 0.5rem; font-weight: bold; }
    .correct { color: #27ae60; }
    .incorrect { color: #c0392b; }
    .loading { color: #2980b9; font-style: italic; }
    button { padding: 0.7rem 1.5rem; background: #3498db; color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; }
    button:hover { background: #2980b9; }
    .result { font-weight: bold; margin-top: 2rem; font-size: 1.2rem; color: #2c3e50; }
    .chart-container { display: flex; align-items: flex-end; height: 150px; border-left: 2px solid #333; border-bottom: 2px solid #333; padding-left: 10px; margin-top: 15px; }
    .bar { background-color: #5dade2; margin: 0 15px; text-align: center; color: #333; position: relative; width: 50px; }
    .bar-label { position: absolute; bottom: -25px; width: 100%; left: 0; }
    table { border-collapse: collapse; margin: 1rem 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>

<h1>P3 Life Cycles of Plants and Animals â€“ Quiz</h1>
<form id="quizForm">

  <!-- MCQ Questions -->
  <div class="question" id="q1">
    <h2>1. Which of the following animals has a 3-stage life cycle where the young looks similar to the adult?</h2>
    <input type="radio" name="q1" value="A"> A. Cockroach<br/>
    <input type="radio" name="q1" value="B"> B. Butterfly<br/>
    <input type="radio" name="q1" value="C"> C. Frog<br/>
    <input type="radio" name="q1" value="D"> D. Mosquito<br/>
    <div class="feedback" id="f1"></div>
  </div>

  <div class="question" id="q2">
    <h2>2. In the life cycle of a butterfly, which stage is mainly for eating and growing rapidly?</h2>
    <input type="radio" name="q2" value="A"> A. Egg<br/>
    <input type="radio" name="q2" value="B"> B. Larva<br/>
    <input type="radio" name="q2" value="C"> C. Pupa<br/>
    <input type="radio" name="q2" value="D"> D. Adult<br/>
    <div class="feedback" id="f2"></div>
  </div>

  <!-- Fill in the blanks -->
  <div class="question" id="q3">
    <h2>3. The nymph of a grasshopper sheds its skin several times as it grows. This process is called __________.</h2>
    <input type="text" name="q3" placeholder="Enter the process name"/>
    <div class="feedback" id="f3"></div>
  </div>

  <div class="question" id="q4">
    <h2>4. A seed needs water, warmth, and __________ to germinate into a seedling.</h2>
    <input type="text" name="q4" placeholder="Enter the missing item"/>
    <div class="feedback" id="f4"></div>
  </div>

  <!-- Short Answer with Data Interpretation -->
  <div class="question" id="q5">
    <h2>5. The graph below shows the number of leaves on a bean plant over three weeks.</h2>
    <div class="chart-container">
        <div class="bar" style="height: 40px;">4<div class="bar-label">Week 1</div></div>
        <div class="bar" style="height: 80px;">8<div class="bar-label">Week 2</div></div>
        <div class="bar" style="height: 120px;">12<div class="bar-label">Week 3</div></div>
    </div>
    <br><br>
    <p>Based on the graph, describe the change in the number of leaves from Week 1 to Week 3.</p>
    <textarea name="q5" rows="3" cols="50"></textarea>
    <div class="feedback" id="f5"></div>
  </div>

  <div class="question" id="q6">
    <h2>6. State one main difference between the nymph of a cockroach and the larva of a butterfly.</h2>
    <textarea name="q6" rows="3" cols="50"></textarea>
    <div class="feedback" id="f6"></div>
  </div>
  
  <div class="question" id="q7">
    <h2>7. In May, a gardener noticed a large increase in the number of adult butterflies in the garden. Which stage of the life cycle must have been present in large numbers in April? Explain your answer.</h2>
    <textarea name="q7" rows="4" cols="50"></textarea>
    <div class="feedback" id="f7"></div>
  </div>

  <!-- Matching -->
  <div class="question" id="q8">
    <h2>8. Match the life cycle stage with its main description.</h2>
    Larva: 
    <select name="q8_larva">
      <option value="">--Select--</option>
      <option value="A">Lays eggs to reproduce.</option>
      <option value="B">The main eating and growing stage; looks very different from the adult.</option>
      <option value="C">An inactive stage where change happens.</option>
      <option value="D">Looks like a small, wingless version of the adult.</option>
    </select><br/><br/>
    Pupa: 
    <select name="q8_pupa">
      <option value="">--Select--</option>
      <option value="A">Lays eggs to reproduce.</option>
      <option value="B">The main eating and growing stage; looks very different from the adult.</option>
      <option value="C">An inactive stage where change happens.</option>
      <option value="D">Looks like a small, wingless version of the adult.</option>
    </select><br/><br/>
    Adult: 
    <select name="q8_adult">
      <option value="">--Select--</option>
      <option value="A">Lays eggs to reproduce.</option>
      <option value="B">The main eating and growing stage; looks very different from the adult.</option>
      <option value="C">An inactive stage where change happens.</option>
      <option value="D">Looks like a small, wingless version of the adult.</option>
    </select><br/><br/>
    Nymph: 
    <select name="q8_nymph">
      <option value="">--Select--</option>
      <option value="A">Lays eggs to reproduce.</option>
      <option value="B">The main eating and growing stage; looks very different from the adult.</option>
      <option value="C">An inactive stage where change happens.</option>
      <option value="D">Looks like a small, wingless version of the adult.</option>
    </select>
    <div class="feedback" id="f8"></div>
  </div>

  <button type="button" onclick="submitQuiz()">Submit Answers</button>
  <div class="result" id="results"></div>
</form>

<script>
const mcqAnswers = { q1: "A", q2: "B" };
const fibAnswers = {
  q3: ["moulting", "molting"], 
  q4: ["air", "oxygen"]
};
const matchAnswers = {
  q8_larva: "B", q8_pupa: "C", q8_adult: "A", q8_nymph: "D"
};
const shortAnswers = {
  q5: "The number of leaves on the plant increased over the three weeks. / The plant grew more leaves over time.",
  q6: "The nymph of a cockroach looks like a smaller version of the adult, but the larva of a butterfly (caterpillar) does not look like the adult butterfly at all.",
  q7: "The pupa stage (or larva/caterpillar stage). This is because the pupa is the stage just before the adult butterfly emerges."
};
// IMPORTANT: Replace with your actual Mistral API key
const mistralAPIKey = "xxxxxxxxx"; 

async function evaluateWithMistral(userInput, modelAnswer) {
  if (!userInput) return "No answer provided.";
  if (mistralAPIKey === "xxxxxxxxx" || mistralAPIKey === "") {
    return "API Key not set. Cannot evaluate short answer.";
  }
  const prompt = `You are a primary school science teacher marking a student's answer. The student's answer is:\n"${userInput}"\n\nThe model answer is:\n"${modelAnswer}"\n\nIs the student's answer correct? The student may use simpler words. Reply with "Correct" or "Incorrect", then explain your reasoning in one short sentence.`;
  try {
    const response = await fetch("https://api.mistral.ai/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${mistralAPIKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "mistral-small-latest",
        messages: [{ role: "user", content: prompt }]
      })
    });
    if (!response.ok) return `Error: ${response.statusText}`;
    const data = await response.json();
    return data.choices?.[0]?.message?.content || "Error in response from API.";
  } catch (error) {
    return "Could not connect to the evaluation service.";
  }
}

async function submitQuiz() {
  let score = 0;
  let total = 0;
  
  document.querySelectorAll('.feedback').forEach(el => el.innerHTML = '');

  // Mark MCQs
  for (let i = 1; i <= 2; i++) {
    const q = `q${i}`;
    const selected = document.querySelector(`input[name="${q}"]:checked`);
    const correct = mcqAnswers[q];
    const feedback = document.getElementById(`f${i}`);
    total++;
    if (selected?.value === correct) {
      feedback.textContent = "Correct!";
      feedback.className = "feedback correct";
      score++;
    } else {
      feedback.textContent = `Incorrect. The correct answer is ${correct}.`;
      feedback.className = "feedback incorrect";
    }
  }

  // Mark Fill-in-the-blanks
  for (let i = 3; i <= 4; i++) {
    const q = `q${i}`;
    const input = document.querySelector(`input[name="${q}"]`).value.trim().toLowerCase();
    const correctAnswers = fibAnswers[q];
    const feedback = document.getElementById(`f${i}`);
    total++;
    if (correctAnswers.includes(input)) {
      feedback.textContent = "Correct!";
      feedback.className = "feedback correct";
      score++;
    } else {
      feedback.textContent = `Incorrect. A correct answer is: ${correctAnswers[0]}.`;
      feedback.className = "feedback incorrect";
    }
  }

  // Mark Matching
  const matchContainer = document.getElementById('f8');
  const matchQs = ["q8_larva", "q8_pupa", "q8_adult", "q8_nymph"];
  let matchScore = 0;
  total += matchQs.length;
  for (let q of matchQs) {
    const select = document.querySelector(`select[name="${q}"]`);
    const correct = matchAnswers[q];
    if (select.value === correct) {
        matchScore++;
        score++;
    }
  }
  matchContainer.textContent = `You got ${matchScore} out of 4 correct.`;
  matchContainer.className = matchScore === 4 ? "feedback correct" : "feedback incorrect";

  // Evaluate Short Answers
  document.getElementById("results").innerText = "Evaluating your answers... please wait.";
  const shortAnswerPromises = [];
  for (let i = 5; i <= 7; i++) {
    const q = `q${i}`;
    const input = document.querySelector(`textarea[name="${q}"]`).value.trim();
    const modelAns = shortAnswers[q];
    const feedback = document.getElementById(`f${i}`);
    feedback.className = "feedback loading";
    feedback.textContent = "Checking...";
    const promise = evaluateWithMistral(input, modelAns).then((result) => {
      feedback.textContent = result;
      feedback.className = result.toLowerCase().startsWith("correct") ? "feedback correct" : "feedback incorrect";
    });
    shortAnswerPromises.push(promise);
  }

  await Promise.all(shortAnswerPromises);
  document.getElementById("results").innerText = `Auto-graded score (MCQ, FIB, Match): ${score} / ${total}. Short answers are evaluated separately above.`;
}
</script>

</body>
</html>
